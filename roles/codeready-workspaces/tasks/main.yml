---
- name: Ensure namespace exists
  k8s:
    kubeconfig: '{{ kubeconfig }}'
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: '{{ crw_project_name }}'
        annotations:
          openshift.io/display-name: '{{ crw_project_display }}'
      spec: {}

- name: Subscribe to CodeReady Workspaces
  k8s:
    kubeconfig: '{{ kubeconfig }}'
    definition: '{{ lookup("template", "codeready-workspaces.yml.j2")|from_yaml }}'

- name: Deploy CodeReady Workspaces via CR
  k8s:
    kubeconfig: '{{ kubeconfig }}'
    definition:
      apiVersion: org.eclipse.che/v1
      kind: CheCluster
      metadata:
        name: codeready-workspaces
        namespace: '{{ crw_project_name }}'
      spec:
        auth:
          identityProviderURL: 'https://keycloak-{{ rhsso_project_name }}.apps.{{ full_cluster_name }}'
          identityProviderRealm: '{{ rhsso_realm_name }}'
          identityProviderClientId: codeready-public
          identityProviderAdminUserName: '{{ crw_admin_user.username }}'
          externalIdentityProvider: true
          openShiftoAuth: false
        database:
          externalDb: false
          postgresImage: registry.redhat.io/rhel8/postgresql-96:1
        k8s: {}
        server:
          cheFlavor: codeready
          selfSignedCert: false
          tlsSupport: false
          cheImage: registry.redhat.io/codeready-workspaces/server-rhel8
          cheImageTag: '2.3'
          pluginRegistryImage: registry.redhat.io/codeready-workspaces/pluginregistry-rhel8:2.3
          devfileRegistryImage: registry.redhat.io/codeready-workspaces/devfileregistry-rhel8:2.3
          customCheProperties:
            CHE_LIMITS_WORKSPACE_IDLE_TIMEOUT: "0"
        storage:
          preCreateSubPaths: true
          pvcClaimSize: 1Gi
          pvcStrategy: per-workspace
  register: codeready_workspaces_deployment
  until: not codeready_workspaces_deployment.failed
  retries: 5
  delay: 10

- name: Create RHSSO Client definition for CRW
  k8s:
    kubeconfig: '{{ kubeconfig }}'
    definition: '{{ lookup("template", "../templates/rhsso-crw-client.yml.j2")|from_yaml }}'

- name: Create CRW Admin User
  k8s:
    kubeconfig: '{{ kubeconfig }}'
    definition: '{{ lookup("template", "../templates/rhsso-user.yml.j2")|from_yaml }}'
