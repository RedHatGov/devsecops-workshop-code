{% for username in workshop_users|json_query("[].username") %}
- apiVersion: tekton.dev/v1beta1
  kind: Task
  metadata:
    name: deploy-app-from-imagestream
    namespace: {{ username }}-cicd
  spec:
    params:
    - name: app_name
      default: tasks
      description: The name of the app
      type: string
    - name: src_project
      default: {{ username }}-cicd
      description: The name of the project from which to copy the ImageStream
      type: string
    - name: dst_project
      default: {{ username }}-dev
      description: The name of the project to which to copy the ImageStream
      type: string
    - name: app_revision
      default: ''
      description: The tag of the container image to copy from src to dst
      type: string
    steps:
    - name: cleanup-dst-project
      script: |
        #!/bin/sh
        set -e -o pipefail

        if oc get dc/$(params.app_name) -n $(params.dst_project) &>/dev/null; then
          echo "Tasks dc exists, cleaning up resources "
          oc delete -n $(params.dst_project) dc/$(params.app_name) svc/$(params.app_name) route/$(params.app_name) || echo "Some resources didn't clean up as expected"
        else
          echo "Tasks dc doesn't exist"
        fi
      image: 'quay.io/openshift/origin-cli:latest'
    - name: deploy-from-imagestream-to-dst-project
      script: |
        #!/bin/sh
        if [ "$(params.app_revision)" = "" ]; then
          GITSHA=`oc get configmap tekton-current-revision -n $(params.src_project) -o jsonpath='{ .data.revision }'`
        else
          GITSHA="$(params.app_revision)"
        fi

        echo "Tagging image stream from $(params.src_project)/$(params.app_name):$GITSHA to $(params.dst_project)/$(params.app_name):$GITSHA"
        oc tag $(params.src_project)/$(params.app_name):$GITSHA $(params.dst_project)/$(params.app_name):$GITSHA

        echo "Deploying new version into $(params.dst_project)"
        oc new-app --image-stream=$(params.app_name):$GITSHA -n $(params.dst_project) --as-deployment-config=true -o yaml  | oc apply -n $(params.dst_project)  -f -
        oc expose svc $(params.app_name) -n  $(params.dst_project)
      image: 'quay.io/openshift/origin-cli:latest'
{% endfor %}
